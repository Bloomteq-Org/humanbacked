import { NextRequest, NextResponse } from "next/server";
import nodemailer from "nodemailer";
import { prisma } from "@/lib/prisma";

const getEmailHtml = () => `
  <!DOCTYPE html>
  <html>
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #1d1d1b; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #ffffff;">
      <div style="background: linear-gradient(118.69% 85.24% at 50% 25.2%, #FFF 0%, #F4F4FF 58.08%, #FFF 84.05%); padding: 40px 20px; text-align: center; border-radius: 12px;">
        <!-- Logo centered on top -->
        <div style="margin-bottom: 32px; text-align: center;">
          <svg width="165" height="22" viewBox="0 0 330 44" fill="none" xmlns="http://www.w3.org/2000/svg" style="max-width: 165px; height: auto; margin: 0 auto;">
            <path d="M29.0909 26.1322V17.5031C29.0909 15.0155 28.4462 12.5905 27.2462 10.4855L26.9993 10.0691L26.9035 9.89475C26.468 9.00864 26.7105 7.8888 27.4911 7.31473C28.2715 6.74124 29.3127 6.91657 29.9024 7.68856L30.0142 7.85127L30.3356 8.38974C31.8893 11.1152 32.7273 14.2653 32.7273 17.5031V26.1322C32.7273 28.149 32.4015 30.1487 31.7667 32.0418L31.4755 32.8455C30.65 34.9722 29.4418 36.9017 27.9207 38.5247C26.3996 40.1479 24.5944 41.4337 22.6118 42.3097C20.8775 43.076 19.0353 43.5169 17.1662 43.6151L16.3636 43.6364L16.1772 43.6267C15.2606 43.5248 14.5455 42.6797 14.5455 41.6529C14.5455 40.5575 15.3595 39.6695 16.3636 39.6695L16.9922 39.6521C18.454 39.5752 19.8931 39.2313 21.2464 38.6332C22.7931 37.9498 24.1982 36.948 25.3782 35.689C26.558 34.4302 27.4905 32.9372 28.1267 31.298H28.1285C28.7647 29.6595 29.0909 27.9035 29.0909 26.1322ZM9.25156e-07 26.1322V20.9488C0.000156167 19.8535 0.814125 18.9655 1.81818 18.9655C2.82224 18.9655 3.63622 19.8535 3.63636 20.9488V26.1341C3.63564 28.7888 4.36905 31.3883 5.74929 33.6068C7.13 35.8264 9.0982 37.5687 11.4116 38.608C12.3401 39.0251 12.7829 40.1849 12.4006 41.1977C12.0419 42.1473 11.0857 42.6318 10.2024 42.3444L10.0284 42.2767L9.4762 42.0172C6.74849 40.6635 4.41422 38.5263 2.73971 35.8343C0.95336 32.9628 -0.00108473 29.5874 9.25156e-07 26.1322ZM8.00425 14.8223C8.40313 13.8175 9.47284 13.3554 10.3942 13.7899C11.3156 14.2248 11.7389 15.3918 11.3406 16.3971C11.0508 17.1277 10.905 17.9136 10.9091 18.704V24.9545C10.8916 26.121 11.2083 27.269 11.8217 28.2453C12.4356 29.2224 13.3192 29.9835 14.359 30.4186C15.3989 30.8538 16.5408 30.9401 17.6296 30.6647C18.7184 30.389 19.6962 29.7667 20.4351 28.8884L21.7738 30.2308L23.1144 31.5712C21.8736 33.0457 20.2444 34.0749 18.45 34.5289C16.6556 34.9826 14.7743 34.8415 13.0557 34.1222C11.5519 33.4926 10.2319 32.4455 9.23118 31.0888L8.82102 30.4884C7.78475 28.8387 7.24298 26.8852 7.27273 24.8906V18.7137C7.26731 17.376 7.51671 16.0517 8.00425 14.8223ZM20.4351 28.8884C21.114 28.0818 22.2645 28.0278 23.0042 28.7683C23.744 29.5091 23.7929 30.7641 23.1144 31.5712L20.4351 28.8884ZM14.5455 24.2398V19.0565C14.5455 17.9611 15.3595 17.0731 16.3636 17.0731C17.3678 17.0731 18.1818 17.9611 18.1818 19.0565V24.2398C18.1818 25.3353 17.3678 26.2232 16.3636 26.2232C15.3595 26.2232 14.5455 25.3353 14.5455 24.2398ZM21.8182 23.7109V18.6885L21.8129 18.365C21.7824 17.6133 21.6144 16.8731 21.3156 16.186C20.9744 15.4005 20.4707 14.7026 19.8384 14.1464C19.206 13.5901 18.4615 13.1899 17.6598 12.9784C16.8581 12.767 16.0219 12.7508 15.2131 12.9299C14.2291 13.1479 13.2681 12.4538 13.0682 11.3804C12.8684 10.307 13.5047 9.25864 14.4886 9.04055C15.8195 8.74579 17.1959 8.77375 18.5156 9.12191C19.8353 9.47015 21.068 10.1318 22.1218 11.0589C23.1756 11.9861 24.0244 13.1574 24.6024 14.4873C25.1767 15.8092 25.4685 17.2531 25.4545 18.7137V23.7109C25.4545 24.8064 24.6405 25.6943 23.6364 25.6943C22.6322 25.6943 21.8182 24.8064 21.8182 23.7109ZM12.1378 0.593525C16.0581 -0.527228 20.2207 -0.047839 23.8193 1.92226L24.5295 2.33678L24.6875 2.44524C25.44 3.02544 25.6829 4.14466 25.2202 5.03883C24.7264 5.99267 23.6158 6.32898 22.7415 5.79035C19.8144 3.98744 16.33 3.49752 13.0593 4.43255C9.7896 5.3676 7.01464 7.64673 5.3338 10.7528L5.33204 10.7548C4.64189 12.0266 4.15525 13.4103 3.89205 14.8495C3.69562 15.9237 2.73724 16.6211 1.75249 16.4068C0.768422 16.1921 0.130691 15.1484 0.326705 14.0747C0.67056 12.1942 1.30524 10.3878 2.20347 8.73258C4.38042 4.71161 7.95684 1.78888 12.1378 0.593525Z" fill="url(#paint0_linear_1_841)"/>
            <path d="M64.7251 8.2037V33.7992H58.4104V23.262H48.5875V33.7992H42.2727V8.2037H48.5875V18.2304H58.4104V8.2037H64.7251ZM87.4156 13.4541V33.7992H81.1008V31.0282C80.4608 31.9276 79.5868 32.6568 78.4789 33.2159C77.3957 33.7506 76.1894 34.018 74.86 34.018C73.2844 34.018 71.8934 33.6777 70.6871 32.9971C69.4807 32.2922 68.5452 31.2834 67.8805 29.9708C67.2158 28.6582 66.8835 27.1147 66.8835 25.3403V13.4541H73.1613V24.5017C73.1613 25.8629 73.5182 26.9203 74.2322 27.6738C74.9461 28.4273 75.9063 28.8041 77.1126 28.8041C78.3435 28.8041 79.316 28.4273 80.0299 27.6738C80.7439 26.9203 81.1008 25.8629 81.1008 24.5017V13.4541H87.4156ZM116.029 13.2353C118.589 13.2353 120.62 14.001 122.122 15.5323C123.648 17.0637 124.411 19.1906 124.411 21.913V33.7992H118.134V22.7516C118.134 21.439 117.777 20.4302 117.063 19.7253C116.373 18.9961 115.413 18.6315 114.182 18.6315C112.951 18.6315 111.979 18.9961 111.265 19.7253C110.576 20.4302 110.231 21.439 110.231 22.7516V33.7992H103.953V22.7516C103.953 21.439 103.596 20.4302 102.882 19.7253C102.193 18.9961 101.233 18.6315 100.002 18.6315C98.7709 18.6315 97.7984 18.9961 97.0845 19.7253C96.3952 20.4302 96.0505 21.439 96.0505 22.7516V33.7992H89.7358V13.4541H96.0505V16.0063C96.6906 15.1556 97.5276 14.4871 98.5616 14.001C99.5956 13.4905 100.765 13.2353 102.07 13.2353C103.621 13.2353 104.999 13.5634 106.206 14.2197C107.437 14.876 108.397 15.8119 109.086 17.0272C109.8 15.9091 110.773 14.9976 112.004 14.2927C113.234 13.5878 114.576 13.2353 116.029 13.2353ZM125.357 23.5902C125.357 21.4998 125.75 19.6646 126.538 18.0846C127.351 16.5046 128.446 15.2893 129.825 14.4385C131.203 13.5878 132.742 13.1624 134.441 13.1624C135.893 13.1624 137.161 13.4541 138.244 14.0374C139.352 14.6208 140.202 15.3865 140.793 16.3345V13.4541H147.107V33.7992H140.793V30.9188C140.177 31.8668 139.315 32.6325 138.208 33.2159C137.124 33.7992 135.856 34.0909 134.404 34.0909C132.73 34.0909 131.203 33.6655 129.825 32.8148C128.446 31.9397 127.351 30.7122 126.538 29.1322C125.75 27.528 125.357 25.6806 125.357 23.5902ZM140.793 23.6266C140.793 22.071 140.349 20.8435 139.463 19.9441C138.601 19.0447 137.543 18.595 136.287 18.595C135.032 18.595 133.961 19.0447 133.075 19.9441C132.213 20.8192 131.782 22.0345 131.782 23.5902C131.782 25.1458 132.213 26.3855 133.075 27.3092C133.961 28.2086 135.032 28.6582 136.287 28.6582C137.543 28.6582 138.601 28.2086 139.463 27.3092C140.349 26.4098 140.793 25.1823 140.793 23.6266ZM162.016 13.2353C164.429 13.2353 166.349 14.0131 167.777 15.5688C169.229 17.1001 169.955 19.2149 169.955 21.913V33.7992H163.678V22.7516C163.678 21.3904 163.321 20.333 162.607 19.5795C161.893 18.826 160.932 18.4492 159.726 18.4492C158.52 18.4492 157.56 18.826 156.846 19.5795C156.132 20.333 155.775 21.3904 155.775 22.7516V33.7992H149.46V13.4541H155.775V16.1522C156.415 15.2528 157.277 14.5479 158.36 14.0374C159.443 13.5027 160.662 13.2353 162.016 13.2353ZM187.823 20.6733C189.324 20.9893 190.531 21.7307 191.442 22.8974C192.352 24.0399 192.808 25.3525 192.808 26.8352C192.808 28.9742 192.045 30.6757 190.518 31.9397C189.017 33.1794 186.912 33.7992 184.204 33.7992H172.128V8.2037H183.797C186.432 8.2037 188.487 8.79922 189.964 9.99028C191.466 11.1813 192.217 12.7978 192.217 14.8396C192.217 16.3466 191.811 17.5984 190.998 18.595C190.211 19.5916 189.152 20.2844 187.823 20.6733ZM178.443 18.5586H182.579C183.613 18.5586 184.401 18.3398 184.942 17.9023C185.508 17.4404 185.792 16.772 185.792 15.8969C185.792 15.0219 185.508 14.3534 184.942 13.8916C184.401 13.4298 183.613 13.1988 182.579 13.1988H178.443V18.5586ZM183.096 28.7676C184.154 28.7676 184.967 28.5367 185.533 28.0749C186.124 27.5887 186.419 26.896 186.419 25.9966C186.419 25.0972 186.112 24.3923 185.496 23.8819C184.905 23.3714 184.081 23.1162 183.022 23.1162H178.443V28.7676H183.096ZM192.999 23.5902C192.999 21.4998 193.393 19.6646 194.18 18.0846C194.993 16.5046 196.088 15.2893 197.467 14.4385C198.846 13.5878 200.384 13.1624 202.083 13.1624C203.536 13.1624 204.803 13.4541 205.887 14.0374C206.995 14.6208 207.844 15.3865 208.435 16.3345V13.4541H214.749V33.7992H208.435V30.9188C207.819 31.8668 206.958 32.6325 205.85 33.2159C204.767 33.7992 203.499 34.0909 202.046 34.0909C200.372 34.0909 198.846 33.6655 197.467 32.8148C196.088 31.9397 194.993 30.7122 194.18 29.1322C193.393 27.528 192.999 25.6806 192.999 23.5902ZM208.435 23.6266C208.435 22.071 207.992 20.8435 207.105 19.9441C206.244 19.0447 205.185 18.595 203.929 18.595C202.674 18.595 201.603 19.0447 200.717 19.9441C199.855 20.8192 199.424 22.0345 199.424 23.5902C199.424 25.1458 199.855 26.3855 200.717 27.3092C201.603 28.2086 202.674 28.6582 203.929 28.6582C205.185 28.6582 206.244 28.2086 207.105 27.3092C207.992 26.4098 208.435 25.1823 208.435 23.6266ZM215.847 23.6266C215.847 21.5119 216.277 19.6646 217.139 18.0846C218.025 16.5046 219.244 15.2893 220.795 14.4385C222.371 13.5878 224.168 13.1624 226.186 13.1624C228.771 13.1624 230.926 13.8308 232.649 15.1677C234.397 16.5046 235.542 18.3884 236.083 20.8192H229.362C228.796 19.2635 227.701 18.4857 226.076 18.4857C224.919 18.4857 223.995 18.9353 223.306 19.8347C222.617 20.7098 222.272 21.9738 222.272 23.6266C222.272 25.2795 222.617 26.5557 223.306 27.455C223.995 28.3301 224.919 28.7676 226.076 28.7676C227.701 28.7676 228.796 27.9898 229.362 26.4341H236.083C235.542 28.8162 234.397 30.6879 232.649 32.0491C230.901 33.4103 228.747 34.0909 226.186 34.0909C224.168 34.0909 222.371 33.6655 220.795 32.8148C219.244 31.964 218.025 30.7487 217.139 29.1687C216.277 27.5887 215.847 25.7414 215.847 23.6266ZM249.838 33.7992L243.56 25.2674V33.7992H237.245V6.81818H243.56V21.7307L249.801 13.4541H257.592L249.025 23.6631L257.666 33.7992H249.838ZM277.281 23.2985C277.281 23.8819 277.244 24.4896 277.171 25.1215H262.879C262.978 26.3855 263.384 27.3578 264.098 28.0384C264.837 28.6947 265.735 29.0229 266.794 29.0229C268.369 29.0229 269.465 28.3666 270.08 27.054H276.801C276.457 28.3909 275.829 29.5941 274.918 30.6636C274.032 31.7331 272.912 32.5717 271.558 33.1794C270.203 33.7871 268.689 34.0909 267.015 34.0909C264.997 34.0909 263.199 33.6655 261.624 32.8148C260.048 31.964 258.817 30.7487 257.931 29.1687C257.045 27.5887 256.602 25.7414 256.602 23.6266C256.602 21.5119 257.032 19.6646 257.894 18.0846C258.78 16.5046 260.011 15.2893 261.587 14.4385C263.162 13.5878 264.972 13.1624 267.015 13.1624C269.009 13.1624 270.782 13.5756 272.333 14.402C273.884 15.2285 275.09 16.4074 275.952 17.9387C276.838 19.4701 277.281 21.2567 277.281 23.2985ZM270.819 21.6578C270.819 20.5882 270.45 19.7375 269.711 19.1055C268.973 18.4735 268.049 18.1575 266.941 18.1575C265.883 18.1575 264.984 18.4614 264.246 19.069C263.532 19.6767 263.089 20.5396 262.916 21.6578H270.819ZM278.249 23.5902C278.249 21.4998 278.643 19.6646 279.431 18.0846C280.243 16.5046 281.339 15.2893 282.718 14.4385C284.096 13.5878 285.635 13.1624 287.334 13.1624C288.688 13.1624 289.919 13.4419 291.026 14.001C292.159 14.56 293.045 15.3136 293.685 16.2615V6.81818H300V33.7992H293.685V30.8824C293.094 31.8546 292.245 32.6325 291.137 33.2159C290.054 33.7992 288.786 34.0909 287.334 34.0909C285.635 34.0909 284.096 33.6655 282.718 32.8148C281.339 31.9397 280.243 30.7122 279.431 29.1322C278.643 27.528 278.249 25.6806 278.249 23.5902ZM293.685 23.6266C293.685 22.071 293.242 20.8435 292.356 19.9441C291.494 19.0447 290.436 18.595 289.18 18.595C287.924 18.595 286.854 19.0447 285.967 19.9441C285.106 20.8192 284.675 22.0345 284.675 23.5902C284.675 25.1458 285.106 26.3855 285.967 27.3092C286.854 28.2086 287.924 28.6582 289.18 28.6582C290.436 28.6582 291.494 28.2086 292.356 27.3092C293.242 26.4098 293.685 25.1823 293.685 23.6266Z" fill="#1D1D1B"/>
            <defs>
              <linearGradient id="paint0_linear_1_841" x1="0" y1="21.8608" x2="32.7273" y2="21.8608" gradientUnits="userSpaceOnUse">
                <stop stop-color="#0C3DDF"/>
                <stop offset="1" stop-color="#B748BE"/>
              </linearGradient>
            </defs>
          </svg>
        </div>

        <!-- Email Content -->
        <div style="text-align: left; max-width: 500px; margin: 0 auto;">
         
          
          <p style="font-size: 16px; margin-bottom: 16px; color: #1d1d1b; line-height: 1.6;">
            Hi there,
          </p>
          
          <p style="font-size: 16px; margin-bottom: 16px; color: #1d1d1b; line-height: 1.6;">
            Thanks for joining the waitlist â€” we're excited to have you with us.
          </p>
          
          <p style="font-size: 16px; margin-bottom: 16px; color: #1d1d1b; line-height: 1.6;">
            You're officially on the list, and we'll be in touch as soon as we're ready to share updates, early access details, or next steps. We're working hard behind the scenes to build something that delivers real value, and your interest helps shape what we're creating.
          </p>
          
          <p style="font-size: 16px; margin-bottom: 16px; color: #1d1d1b; line-height: 1.6;">
            In the meantime, feel free to keep an eye on your inbox. We'll only reach out with relevant updates and important announcements.
          </p>
          
          <p style="font-size: 16px; margin-bottom: 24px; color: #1d1d1b; line-height: 1.6;">
            Thanks again for signing up â€” we appreciate your support.
          </p>
          
          <p style="font-size: 16px; margin-top: 32px; color: #1d1d1b; line-height: 1.6;">
            Best,<br>
            HumanBacked Team
          </p>
        </div>
      </div>
    </body>
  </html>
`;

const getEmailText = () => `
You're on the waitlist ðŸŽ‰

Hi there,

Thanks for joining the waitlist â€” we're excited to have you with us.

You're officially on the list, and we'll be in touch as soon as we're ready to share updates, early access details, or next steps. We're working hard behind the scenes to build something that delivers real value, and your interest helps shape what we're creating.

In the meantime, feel free to keep an eye on your inbox. We'll only reach out with relevant updates and important announcements.

Thanks again for signing up â€” we appreciate your support.

Best,
HumanBacked Team
`;

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { email } = body;

    // Validate email
    if (!email || typeof email !== "string") {
      return NextResponse.json({ success: false, error: "Email is required" }, { status: 400 });
    }

    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i;
    if (!emailPattern.test(email.trim())) {
      return NextResponse.json({ success: false, error: "Invalid email address" }, { status: 400 });
    }

    const trimmedEmail = email.trim().toLowerCase();

    // Check if email already exists in database
    const existingEmail = await prisma.waitlistEmail.findUnique({
      where: { email: trimmedEmail },
    });

    // If email already exists, return success (don't send duplicate email)
    if (existingEmail) {
      return NextResponse.json(
        { success: true, message: "You're already on the waitlist!" },
        { status: 200 },
      );
    }

    // Save email to database FIRST (before sending email)
    await prisma.waitlistEmail.create({
      data: {
        email: trimmedEmail,
      },
    });

    // Get Gmail credentials from environment variables
    const gmailUser = process.env.GMAIL_USER;
    const gmailAppPassword = process.env.GMAIL_APP_PASSWORD;
    // Use Gmail user as from email to avoid verification issues
    const fromEmail = gmailUser;

    if (!gmailUser || !gmailAppPassword) {
      console.error("Gmail credentials not configured");
      return NextResponse.json(
        {
          success: false,
          error: "Something went wrong. Please contact us on info@humanbacked.com",
        },
        { status: 500 },
      );
    }

    // Create transporter for Gmail SMTP
    const transporter = nodemailer.createTransport({
      service: "gmail",
      auth: {
        user: gmailUser,
        pass: gmailAppPassword,
      },
    });

    // Send email (if this fails, email is still saved in database)
    try {
      await transporter.sendMail({
        from: `HumanBacked <${fromEmail}>`,
        replyTo: process.env.GMAIL_FROM_EMAIL || fromEmail, // Use custom email as reply-to
        to: email.trim(),
        subject: "You're on the waitlist ðŸŽ‰",
        text: getEmailText(), // Plain text version
        html: getEmailHtml(),
        headers: {
          // Prevent email from being collapsed/truncated
          "X-Mailer": "HumanBacked",
          "X-Priority": "1", // High priority - prevents collapsing
          Importance: "high",
          "List-Unsubscribe": `<mailto:${process.env.GMAIL_FROM_EMAIL || fromEmail}?subject=unsubscribe>`,
          "List-Unsubscribe-Post": "List-Unsubscribe=One-Click",
        },
      });
    } catch (emailError) {
      // Log email error but don't fail the request since email is already saved
      console.error("Failed to send email, but email is saved in database:", emailError);
    }

    return NextResponse.json(
      { success: true, message: "Subscribed successfully! Check your email for confirmation." },
      { status: 200 },
    );
  } catch (error) {
    console.error("Subscribe error:", error);
    return NextResponse.json(
      { success: false, error: "Something went wrong. Please try again." },
      { status: 500 },
    );
  }
}
